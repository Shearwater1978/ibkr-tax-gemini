<!DOCTYPE html>
<html>
<head>
    <title>IBKR Tax Architect v2.1</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1 { color: #2c3e50; margin-bottom: 5px; }
        h3 { margin-top: 0; color: #34495e; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        /* Spinner Styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #007bff;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-box {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background: #e7f1ff;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* –û—Ç–∫–ª—é—á–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Controls */
        .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; transition: background 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-outline { background: transparent; border: 1px solid #007bff; color: #007bff; }
        .btn-outline:hover { background: #e7f1ff; }
        
        /* Metrics Grid */
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .metric-box { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .metric-val { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .metric-label { font-size: 13px; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Status Bar */
        #status { margin-top: 10px; font-size: 14px; color: #666; min-height: 20px; }
        .status-success { color: green; }
        .status-error { color: red; }
        
        /* Hidden sections */
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üáµüá± Tax Architect</h1>
        <p style="color:#666; margin-bottom: 20px">SQLCipher Secured ‚Ä¢ FIFO Engine ‚Ä¢ NBP Rates</p>
        
        
        <div class="card">
            <h3>üìÅ Data Management</h3>
            <div class="controls">
                <button class="btn btn-outline" onclick="runImport()">üì• Re-Import CSV Data</button>
                <span id="import-status" style="font-size: 14px; color: #666;">Using existing DB</span>
            </div>
        </div>

        
        <div class="card">
            <h3>üßÆ Tax Calculation</h3>
            <div class="controls">
                <label>Select Year:</label>
                <select id="yearSelect">
                    <option value="" disabled selected>Loading...</option>
                </select>
                <button class="btn btn-primary" onclick="calculate()">Calculate Report</button>
            </div>
            <div id="loader" class="loading-box hidden">
                <div class="spinner"></div>
                <span id="loader-text">Calculating FIFO & NBP Rates...</span>
            </div>
            <div id="status"></div>
        </div>

        
        <div class="card hidden" id="resultsCard">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>üìä Results</h3>
                <div class="controls" style="margin-bottom:0">
                    <button id="btnExcel" class="btn btn-success hidden" onclick="openReport('excel')">üìÑ Open Excel</button>
                    <button id="btnPdf" class="btn btn-success hidden" onclick="openReport('pdf')">üìï Open PDF</button>
                </div>
            </div>
            
            <br>
            <div class="metrics-grid">
                <div class="metric-box">
                    <div class="metric-label">Realized P&L</div>
                    <div class="metric-val" id="pl">0.00 PLN</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Dividends (Gross)</div>
                    <div class="metric-val" id="divs">0.00 PLN</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Open Lots</div>
                    <div class="metric-val" id="inv">0</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        const statusEl = document.getElementById('status');
        const importStatusEl = document.getElementById('import-status');

        window.onload = async () => {
            loadYears();
        };

        async function loadYears(retries = 5, delay = 1000) {
            const select = document.getElementById('yearSelect');
            
            for (let i = 0; i < retries; i++) {
                try {
                    statusEl.innerText = i > 0 ? `Connecting to backend (Attempt ${i+1})...` : "";
                    
                    const res = await fetch(`${API_URL}/years`);
                    if (!res.ok) throw new Error('Backend not ready');
                    
                    const data = await res.json();
                    select.innerHTML = '';
                    
                    if (data.years && data.years.length > 0) {
                        data.years.forEach(y => {
                            const opt = document.createElement('option');
                            opt.value = y;
                            opt.innerText = y;
                            select.appendChild(opt);
                        });
                        select.value = data.years[0];
                        statusEl.innerText = ""; // Clear status on success
                    } else {
                        const opt = document.createElement('option');
                        opt.innerText = "No Data found";
                        select.appendChild(opt);
                    }
                    return; // Success! Exit the loop
                    
                } catch (e) {
                    console.warn(`Connection attempt ${i + 1} failed. Retrying...`);
                    if (i === retries - 1) {
                        statusEl.innerText = "Error connecting to Backend. Please try to Re-Import.";
                        statusEl.className = "status-error";
                    }
                    // Wait before next retry
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function runImport() {
            importStatusEl.innerText = "Parsing CSVs... please wait.";
            try {
                const res = await fetch(`${API_URL}/import`, { method: 'POST' });
                const data = await res.json();
                importStatusEl.innerText = data.message + ` (${data.count} records)`;
                loadYears(); 
            } catch (e) {
                importStatusEl.innerText = "Import Failed.";
            }
        }

        async function calculate() {
            const yearSelect = document.getElementById('yearSelect');
            const year = yearSelect.value;
            const calcBtn = document.querySelector('button[onclick="calculate()"]');
            const loader = document.getElementById('loader');
            const resultsCard = document.getElementById('resultsCard');

            if(!year || year === "No Data found") return;

            // 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ UI
            statusEl.innerText = "";
            statusEl.className = "";
            loader.classList.remove('hidden');    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            calcBtn.disabled = true;              // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            resultsCard.classList.add('hidden');  // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

            try {
                const res = await fetch(`${API_URL}/calculate/${year}`);
                const data = await res.json();
                
                if (res.status !== 200) {
                    statusEl.innerText = data.detail || "Calculation Error";
                    statusEl.className = "status-error";
                    return;
                }

                // 2. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                document.getElementById('pl').innerText = data.summary.pln_profit.toFixed(2) + " PLN";
                document.getElementById('divs').innerText = data.summary.pln_dividend_gross.toFixed(2) + " PLN";
                document.getElementById('inv').innerText = data.summary.open_positions_count;
                
                // –ö–Ω–æ–ø–∫–∏ –æ—Ç—á–µ—Ç–æ–≤
                document.getElementById('btnExcel').classList.toggle('hidden', !data.excel_available);
                document.getElementById('btnPdf').classList.toggle('hidden', !data.pdf_available);

                // 3. –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                resultsCard.classList.remove('hidden');
                statusEl.innerText = `Reports for ${year} are ready!`;
                statusEl.className = "status-success";

            } catch (e) {
                statusEl.innerText = "Connection lost. Check if Backend is running.";
                statusEl.className = "status-error";
            } finally {
                // 4. –û—á–∏—Å—Ç–∫–∞ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞)
                loader.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
                calcBtn.disabled = false;       // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            }
        }

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–æ–≤
        async function openReport(type) {
            const year = document.getElementById('yearSelect').value;
            try {
                // –í—ã–∑—ã–≤–∞–µ–º –±—ç–∫–µ–Ω–¥, —á—Ç–æ–±—ã –æ–Ω –æ—Ç–∫—Ä—ã–ª —Ñ–∞–π–ª –≤ —Å–∏—Å—Ç–µ–º–µ
                await fetch(`${API_URL}/open/${type}/${year}`);
            } catch (e) {
                alert("Could not open file. Make sure it is not already open in another program.");
            }
        }
    </script>
</body>
</html>
