# Техническая спецификация: IBKR Tax Assistant (v1.2.0)

## 1. Цель проекта
Автоматизация расчета налогов (PIT-38) для резидентов Польши (Interactive Brokers).
Поддержка сложных корпоративных действий, FIFO, конвертации валют (NBP D-1) и оптимизации истории сделок через систему Снэпшотов.

## 2. Архитектура
* **Язык:** Python 3.10+
* **Core:**
    * `src/parser.py`: Парсинг CSV, дедупликация (GE), фикс дат (KVUE), поиск скрытых тикеров (Spin-offs).
    * `src/fifo.py`: Движок FIFO. Поддерживает `save_state`/`load_state` (JSON) для переноса остатков между годами.
    * `src/processing.py`: Оркестратор. Умеет загружать Snapshot и игнорировать старые сделки.
    * `src/nbp.py`: API Нацбанка Польши.
* **Tools:**
    * `main.py`: Точка входа. Автоматически ищет подходящий снэпшот для выбранного года.
    * `create_snapshot.py`: Утилита для генерации JSON-слепка инвентаря на конец года.
    * `src/report_pdf.py`: Генерация PDF (PIT-38, Monthly Divs, Reconcilliation Check).

## 3. Бизнес-логика

### 3.1. Парсинг и Данные
* **Коррекция данных:**
    * KVUE: Хардкод даты `2023-08-23` для "Voluntary Offer" (Time Travel Fix).
    * GE: Удаление дубликатов сплитов из одного файла.
    * Spin-offs: WBD, OGN, FG извлекаются из текстового описания.
* **FIFO Priority:** Внутри одного дня операции сортируются: Split -> Transfer/Buy -> Sell.

### 3.2. Оптимизация (Snapshots)
* **Проблема:** Хранение CSV за 10 лет неудобно и избыточно.
* **Решение:**
    1.  Пользователь генерирует `snapshot_YYYY.json` (состояние инвентаря на 31.12.YYYY).
    2.  При расчете года `YYYY+1` скрипт загружает JSON и использует его как базу Cost Basis.
    3.  Старые CSV файлы можно удалить, FIFO продолжает работать корректно.

### 3.3. Налоговая математика & Отчетность
* **Reconciliation:** Сверка "Broker View" vs "FIFO Engine View". Статус `OK` или `MISMATCH`.
* **Visuals:** Красная подсветка для заблокированных активов (RUB, Sanctions).
* **Layout:** "Spacious" режим для дивидендов (удобная сверка с банком).

## 4. Стек
* `reportlab` (PDF)
* `requests` (API)
* `pytest` (Tests: Edge cases coverage)
