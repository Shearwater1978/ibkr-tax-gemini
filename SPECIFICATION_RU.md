# Спецификация проекта: IBKR Tax Assistant (Польша/PIT-38)

### Роль
Действуй как Старший Python-разработчик (Senior Python Developer) и эксперт в области финансовых технологий (FinTech).

### Цель
Создать надежное Python-приложение для автоматизации расчета налогов по отчетам **Interactive Brokers (IBKR)** специально для **Налоговых резидентов Польши**. Результат работы программы должен облегчать заполнение налоговой декларации **PIT-38**.

### Ключевой функционал и логика

1.  **Управление входными данными:**
    * **Источник:** Сканирование папки `data/` на наличие CSV-файлов (Activity Reports от IBKR).
    * **Гибкость:** Поддержка загрузки отчетов за месяц, за год или смешанных периодов.
    * **Ручная история:** Поддержка файла `manual_history.csv` для импорта исторических сделок ("Genesis Block"), которых нет в отчетах IBKR (например, от предыдущего брокера).
    * **Фильтрация:** Явное игнорирование тестовых/фиктивных тикеров (например, "EXAMPLE", "DUMMY"), чтобы они не попадали в финальный отчет.

2.  **Движок парсинга (Parsing Engine):**
    * Извлечение данных: **Сделки (Trades)** (Покупка/Продажа), **Дивиденды (Dividends)** и **Удержанные налоги (Withholding Taxes)**.
    * **Обработка переводов:** Распознавание и фильтрация не налогооблагаемых событий, таких как ACATS или внутренние переводы (Internal Transfers). Они не считаются покупкой/продажей, но учитываются для целостности портфеля.
    * **Извлечение тикеров:** Надежная Regex-логика для извлечения "чистых" тикеров из описаний IBKR (например, из `MSFT(US...)` достать `MSFT`).

3.  **Финансовая логика (Ядро):**
    * **FIFO (First-In-First-Out):** Сопоставление продаж с покупками в хронологическом порядке для расчета Реализованной Прибыли/Убытка (P&L).
    * **Курсы валют (NBP):**
        * Получение официальных курсов от **Национального Банка Польши (NBP)** через API.
        * **Правило D-1:** Строгое соблюдение налогового правила: использовать курс *рабочего дня, предшествующего* событию.
        * **Умная рекурсия:** Если день D-1 выпадает на выходной или праздник, рекурсивно искать ближайший предыдущий рабочий день.
    * **Оптимизация (Bulk Cache):** Вместо сотен ежедневных запросов скачивать курс валюты *сразу за весь год* одним запросом и кэшировать его локально (JSON) для максимальной скорости.
    * **Точность:** Использование типа `Decimal` для всех денежных расчетов, чтобы избежать ошибок плавающей запятой.

4.  **Отчетность (PDF Output):**
    * **Библиотека:** `reportlab`.
    * **Структура (6 страниц):**
        1.  **Титульный лист:** Налоговый год и Отчетный период (ДД-ММ-ГГГГ).
        2.  **Портфель:** Состав портфеля на конец года (Тикер, Количество до 3 знаков).
        3.  **История сделок:** Хронологический список всех исполненных сделок за год. Начинается с новой страницы.
        4.  **Дивиденды (по месяцам):** Сводка по месяцам (Брутто, Налог, Нетто).
        5.  **Годовая сводка:** Основные метрики, диагностика (количество строк) и итоги по валютам.
        6.  **Помощник PIT-38:** Финальные цифры для **Секции C** (Акции) и **Дивидендов** (Иностранный налог), отформатированные специально для переноса в декларацию.
    * **Стилизация:** Профессиональная разметка "Зебра" (чередование серых/белых строк) для удобства чтения. Заголовки таблиц центрированы.

5.  **Контроль качества (QA):**
    * **Юнит-тесты (`pytest`):**
        * Мокирование (Mocking) запросов к API NBP (тесты работают без интернета).
        * Проверка логики FIFO (частичные продажи, множественные покупки).
        * Проверка фильтров парсера (игнорирование dummy-тикеров).
        * Проверка математического округления (Banker's rounding).
    * **Чистый код:** Понятная структура, аннотации типов (type hinting).

### Структура проекта

```text
project_root/
├── src/
│   ├── parser.py       # Парсинг CSV и Regex
│   ├── fifo.py         # Логика сопоставления сделок
│   ├── nbp.py          # API НБП и логика кэширования
│   ├── processing.py   # Агрегация данных и оркестрация
│   ├── report_pdf.py   # Генерация PDF (ReportLab)
│   └── utils.py        # Математические утилиты (Decimal)
├── tests/              # Набор тестов Pytest
├── data/               # Папка для CSV файлов пользователя
├── output/             # Папка для готовых PDF и JSON
├── main.py             # Точка входа
└── manual_history.csv  # Опциональный файл ручного ввода
```

### Поток выполнения (Execution Flow)
1.  **Загрузка (Ingest):** Чтение `manual_history.csv` + всех CSV из папки `data/`.
2.  **Дедупликация:** Использование хеш-сигнатур для предотвращения дублей, если отчеты перекрываются по датам.
3.  **Определение лет:** Автоматическое определение лет, в которых были налогооблагаемые события (Продажи или Дивиденды).
4.  **Обработка (Process):** Для каждого найденного года:
    * Получение курсов NBP (Пакетная загрузка).
    * Расчет FIFO и Налогов.
    * Генерация отчетов JSON и PDF.