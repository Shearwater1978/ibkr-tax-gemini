# Техническая спецификация: IBKR Tax Assistant (v1.1.0)

## 1. Цель проекта
Автоматизация расчета налогов (PIT-38) для налоговых резидентов Польши, использующих брокера Interactive Brokers (IBKR).
Приложение парсит CSV-отчеты, рассчитывает прибыль по методу FIFO, конвертирует валюты по курсу NBP (день D-1) и генерирует подробный PDF-отчет.

## 2. Архитектура
* **Язык:** Python 3.10+
* **Типы данных:** `Decimal` для всех финансовых расчетов.
* **Модульность:**
    * `src/parser.py`: Разбор CSV, классификация транзакций (включая дедупликацию и фиксы дат).
    * `src/fifo.py`: Логика очереди FIFO, учет остатков, умная сортировка (Split -> Buy -> Sell).
    * `src/nbp.py`: API к Нацбанку Польши.
    * `src/processing.py`: Оркестратор расчетов.
    * `src/report_pdf.py`: Генерация отчета (Spacious Layout, Red Highlights).

## 3. Ключевые функции и Бизнес-логика

### 3.1. Парсинг и Данные
* **Мульти-аккаунты:** Слияние истории.
* **Корпоративные действия:**
    * **Spin-offs:** WBD, OGN, FG (поиск скрытых тикеров).
    * **Mergers:** KVUE Voluntary Offer (хардкод даты 2023-08-23 для синхронизации).
    * **Splits:** GE (дедупликация повторов в CSV).
* **Time Travel Fix:** Исправление ситуаций, когда продажа записана в отчете раньше, чем поступление акций в тот же день.

### 3.2. Налоги и FIFO
* **FIFO:** First-In-First-Out.
* **Правило D-1:** Курс NBP за предыдущий рабочий день.
* **Сверка (Reconciliation):** Колонка "FIFO Check" в PDF. Сравнивает `Sum(Buy) - Sum(Sell)` с остатком в движке FIFO.

### 3.3. Отчетность
* **PDF:** Подробная разбивка дивидендов (1 месяц = 1 блок), помощь для PIT-38.
* **Санкции:** Визуальное выделение заблокированных активов (RUB).

## 4. Зависимости
* `reportlab`, `requests`, `pytest`.
